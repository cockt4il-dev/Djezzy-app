{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>

    

    #table {
        
    }

    /* Responsive cards container */
    .cards-container {
        
        display: flex;
        flex-wrap: nowrap;
        gap: 25px;
        margin-bottom: 5px;
        

    }

    .card {
    flex: 1; /* Makes all cards take equal width */
    min-width: 225px; /* Ensures they don't shrink too much */
    min-height: 125px;
    text-align: center;
    padding: 20px;
    background-color: white;
    border: none;
    border-radius: 10px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    
    /* New fix: Center text vertically */
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 120px; /* Adjust height as needed */

    transition: all 0.15s ease ;
}


    .card-8 {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    flex: 1; /* Makes all cards take equal width */
    min-width: 225px; /* Ensures they don't shrink too much */
    min-height: 20vh; /* Minimum height based on the viewport */
    text-align: center;
    padding: 20px;
    background-color: white;
    border: none;
    border-radius: 10px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.15s ease;
    /* Removed height to avoid conflict with min-height */
}

/* Ensuring proper spacing with padding on smaller screens */
@media (max-width: 768px) {
    .card-8 {
        min-height: 30vh; /* Adjust for smaller screens if necessary */
    }
}


    .card:hover{

        transform: scale(1.05);
        


    }

    /* Adjust cards layout on smaller screens */
    @media (max-width: 768px) {
        .cards-container {
            flex-direction: column;
        }
    }


    .main-content{
        background-color: #F9F9F9;
        min-width: calc(100vw - var(--sidebar-width));
    }

    h5{
        font-weight: bold;
        font-size:xx-large;
    }


    .input {

  max-width: 300px;
  background-color: #f5f5f5;
  color: #242424;
  padding: .15rem .5rem;
  min-height: 40px;
  border-radius: 4px;
  border: none;
  outline: none;
  
  line-height: 2;
  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}



input:focus {
  border-bottom: 2px solid #EE171E;
  border-radius: 4px 4px 2px 2px;
}

input:hover {
  outline: 1px solid lightgrey;
}

.search-container {
        display: flex;
        justify-content: space-between; /* This will push content to the left and right */
        align-items: center; /* Ensures vertical alignment */
        width: 100%;
        padding: 10px; /* Adjust as needed */
        margin-top: 2%;
    }

    .search-container h2 {
        margin-bottom: 0;
    }

    .search-container .dropdown {
        margin-left: auto; /* This will push the dropdown to the right */
    }

    .search-container .input {
        max-width: 220px;
    }

#show-more-btn{

    border-radius: 8px;  
    border: none;
    min-height: 45px;
    min-width: 45px;
    background-color: #EE171E;
    color: white;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);

}

#filter-btn{

border-radius: 8px;  
border: none;
min-height: 40px;
min-width: 45px;
margin-right: 10px;
background-color: #EE171E;
color: white;
box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);

}

#filterDropdown {
    background-color: #EE171E;
    border: none;
}

#apply-filter-btn{
    background-color: #EE171E;
    border: none;
}

#table thead th {
            background-color: #F5F5F5; 
            color: black; 
            padding: 10px; 
        }
.progres-bar-striped{
    background-color: red;
}

    /* Circle Progress Styling */


    .progress-container {
    display: grid;
    place-items: center;
    width: 80%;
    max-width: 150px;
    aspect-ratio: 1;
}

.progress-circle {
    grid-area: 1 / 1;
    width: 100%;
    height: 100%;
}




        

    
    .card-title {
    width: 100%;
    text-align: center;
    margin-bottom: 10px; /* Space below the title */
}

  

.progress-icon {
    grid-area: 1 / 1;
    font-size: 20px;
    color: #979797;
}

    /* Centered FontAwesome Icon */
    

    /* Tooltip Styling */
    .progress-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.85);  /* Slightly transparent black */
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    text-align: center;
    line-height: 1.5;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    white-space: nowrap;
    z-index: 10;
    display: none;
}

.custom-legend {
    display: flex;
    justify-content: center;
    margin-top: 10px;
    padding-top: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin: 0 10px;
    font-size: 14px;
    color: #333;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}

@media (max-width: 768px) {
    .cards-container {
        flex-direction: column;
    }
    
    .large-card, .small-card {
        width: 100%; /* Make them stack */
    
    }
}

.large-card {
    flex: 2; /* Takes more space */
    min-width: 300px; /* Prevents it from becoming too small */
    overflow: hidden;
}
.small-card {
    flex: 1; /* Takes up smaller space */
    min-width: 200px; /* Prevents squeezing */
}


.table-responsive {
        max-height: 60vh;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
.table thead {
            position: sticky;
            top: 0;
            z-index: 10;
}
</style>

<div class="main-content">
    <div class="container-fluid">


    
    <div class="row my-3">
        <div class="col">
            <h4>NPS Questions</h4>
        </div>
    </div>
    
    
    


    <!-- Cards Section -->
    <div class="cards-container">
        <div class="card">
            
        </div>
        <div class="card">
            <h5>#</h5>
            <p><strong>45</strong></p>
        </div>
        <div class="card">
            <h5>#</h5>
            <p><strong>5</strong></p>
        </div>
        
    </div>

    <div class="row mt-5">
        <div class="cards-container">
            <div class="card-8 large-card">
                <h4><strong>Questions per survey type</strong></h5>
                <canvas id="surveyChart" style="max-height: 250px"></canvas>
            </div>
            <div class="card-8 small-card">
                <div class="card-title">
                    <h4><strong>Total questions</strong></h4>
                    <h5>{{ total_questions }}</h5>
                </div>
                <div class="progress-container">
                    <div class="progress-circle third"></div>
                    <div class="progress-circle second"></div>
                    <div class="progress-circle first"></div>
                    <div class="progress-tooltip">28%</div>
                    <div class="progress-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="custom-legend">
                    <span class="legend-item"><span class="legend-color" style="background-color: #EF233C;"></span> FRE</span>
                    <span class="legend-item"><span class="legend-color" style="background-color: #8D99AE;"></span> ARD</span>
                    <span class="legend-item"><span class="legend-color" style="background-color: #EDF2F4;"></span> ARA</span>
                </div>
            </div>
            <div class="card-8 small-card">
                <div class="card-title">
                    <h4><strong>Total questions</strong></h4>
                    <h5>{{ total_questions }}</h5>
                </div>
                <div class="progress-container">
                    <div class="progress-circle third"></div>
                    <div class="progress-circle second"></div>
                    <div class="progress-circle first"></div>
                    <div class="progress-tooltip">28%</div>
                    <div class="progress-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="custom-legend">
                    <span class="legend-item"><span class="legend-color" style="background-color: #EF233C;"></span> FRE</span>
                    <span class="legend-item"><span class="legend-color" style="background-color: #8D99AE;"></span> ARD</span>
                    <span class="legend-item"><span class="legend-color" style="background-color: #EDF2F4;"></span> ARA</span>
                </div>
            </div>
        </div>
        
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById("multiSegmentProgress").getContext("2d");
    
        new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Segment 1", "Segment 2", "Segment 3"], // Optional labels
                datasets: [{
                    data: [28, 24, 48], // Percentages (total 100%)
                    backgroundColor: ["#EF233C", "#EDF2F4", "#8D99AE"], // Colors for segments
                    borderWidth: 0, // Removes the gap between segments
                    cutout: "80%", // Controls the inner empty space (adjust for thickness)
                    borderRadius: 10,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.raw + "%"; // Show percentage
                            }
                        }
                    }
                }
            }
        });
    </script>
    
    <div class="search-container d-flex align-items-center gap-3">
        <h2 class="mb-3" >Questions overview table</h2>
        <!-- Bootstrap Dropdown -->
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Filter
            </button>
            <div class="dropdown-menu p-3" aria-labelledby="filterDropdown">
                <!-- Lang_ID Dropdown -->
                <label for="langSelect" class="form-label">Lang ID</label>
                <select id="langSelect" class="form-select mb-2">
                    <option value="">-- Select --</option>
                    {% for lang in lang_ids %}
                        <option value="{{ lang }}">{{ lang }}</option>
                    {% endfor %}
                </select>
    
                <!-- Question Type Dropdown -->
                <label for="questionTypeSelect" class="form-label">Question Type</label>
                <select id="questionTypeSelect" class="form-select">
                    <option value="">-- Select --</option>
                    {% for qst in question_types %}
                        <option value="{{ qst }}">{{ qst }}</option>
                    {% endfor %}
                </select>
    
                <!-- Apply Button -->
                <button class="btn btn-primary mt-3 w-100" id="apply-filter-btn">Apply</button>
            </div>
        </div>
    
        <!-- Search Input -->
        <input placeholder="Search..." type="text" id="search-bar" name="text" class="input form-control" style="max-width: 220px;">
    </div>
    
    <!-- Table Section -->
    
    <div class="table-responsive">
        <table class="table table-bordered" id="table">
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Survey Type</th>
                    <th scope="col">Lang ID</th>
                    <th scope="col">Question Number</th>
                    <th scope="col">Regexp Replace</th>
                    <th scope="col">Question Name</th>
                    <th scope="col">Question Type</th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for item in page_obj %}
                <tr>
                    <th scope="row">{{ item.id }}</th>
                    <td>{{ item.survey_type_id }}</td>
                    <td class="lang-id">{{ item.lang_id }}</td>
                    <td>{{ item.question_number }}</td>
                    <td>{{ item.regexp_replace }}</td>
                    <td>{{ item.question_name }}</td>
                    <td class="question-type">{{ item.question_type }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    
    <button id="show-more-btn" data-page="2" class="btn btn-primary">Show All</button>

    </div>
    
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-circle-progress/1.2.2/circle-progress.min.js"></script>





<script>
$(document).ready(function () {
    function fetchAndCalculate() {
        $.getJSON("/api/lang-chart-data/", function (response) {
            let total = response.data.reduce((acc, val) => acc + val, 0);
            let percentages = response.data.map(value => value / total);

            let data = [
                { value: percentages[0], color: "#EF233C", label: response.labels[0] },
                { value: percentages[1], color: "#EDF2F4", label: response.labels[1] },
                { value: percentages[2], color: "#8D99AE", label: response.labels[2] }
            ];

            function createCircle(selector, value, color, startOffset, label) {
                let $circle = $(selector);
                
                $circle.circleProgress({
                    value: value,
                    size: 150,
                    thickness: 8,
                    emptyFill: "rgba(0,0,0,0)",
                    startAngle: (-Math.PI / 2) + (2 * Math.PI * startOffset),
                    lineCap: "round",
                    fill: { color: color }
                }).on("circle-animation-progress", function () {
                    let tooltipText = `
                        <span style="color: #EF233C; font-size: 16px;">●</span> <strong>${Math.round(data[0].value * 100)}%</strong> - ${data[0].label} <br>
                        <span style="color: #EDF2F4; font-size: 16px;">●</span> <strong>${Math.round(data[1].value * 100)}%</strong> - ${data[1].label} <br>
                        <span style="color: #8D99AE; font-size: 16px;">●</span> <strong>${Math.round(data[2].value * 100)}%</strong> - ${data[2].label}
                    `;
                    $(".progress-tooltip").html(tooltipText);
                });

                $circle.parent().hover(
                    function () { $(".progress-tooltip").fadeIn(); },
                    function () { $(".progress-tooltip").fadeOut(); }
                );
            }

            createCircle(".progress-circle.first", data[0].value, data[0].color, 0, data[0].label);
            createCircle(".progress-circle.second", data[1].value, data[1].color, data[0].value, data[1].label);
            createCircle(".progress-circle.third", data[2].value, data[2].color, data[0].value + data[1].value, data[2].label);
        });
    }

    fetchAndCalculate();
});

</script>






<script>
    $(document).ready(function () {
        // Show more functionality (unchanged)
        $("#show-more-btn").click(function () {
            let page = $(this).attr("data-page");  
    
            $.ajax({
                url: window.location.pathname,  
                type: "GET",
                data: { page: page },
                dataType: "json",
                success: function (response) {
                    if (response.data.length > 0) {
                        response.data.forEach(item => {
                            $("#table-body").append(
                                `<tr>
                                    <th scope="row">${ item.id }</th>
                                    <td>${ item.survey_type_id }</td>
                                    <td class="lang-id">${ item.lang_id.trim() }</td>  <!-- Added class for filtering -->
                                    <td>${ item.question_number }</td>
                                    <td>${ item.regexp_replace }</td>
                                    <td>${ item.question_name }</td>
                                    <td class="question-type">${ item.question_type.trim() }</td>  <!-- Added for filtering -->
                                </tr>`
                            );
                        });
    
                        if (response.has_next) {
                            $("#show-more-btn").attr("data-page", parseInt(page) + 1);
                        } else {
                            $("#show-more-btn").hide();  
                        }
                        applyFilter();
                    }
                }
            });
        });
    
        // Apply filter functionality
       
          
      
    });
    </script>


<script>

function applyFilter() {
    let selectedLang = $("#langSelect").val().trim();
    let selectedQuestionType = $("#questionTypeSelect").val().trim();

    $.ajax({
        url: "/filtered-data/",  // Call the Django endpoint
        type: "GET",
        data: {
            lang_id: selectedLang,
            question_type: selectedQuestionType
        },
        dataType: "json",
        success: function (response) {
            $("#table-body").empty();  // Clear old table rows

            response.data.forEach(item => {
                $("#table-body").append(
                    `<tr>
                        <th scope="row">${ item.id }</th>
                        <td>${ item.survey_type_id }</td>
                        <td class="lang-id">${ item.lang_id }</td>
                        <td>${ item.question_number }</td>
                        <td>${ item.regexp_replace }</td>
                        <td>${ item.question_name }</td>
                        <td class="question-type">${ item.question_type }</td>
                    </tr>`
                );
            });
        }
    });
}

$(document).ready(function () {
    $("#apply-filter-btn").click(function () {
        applyFilter();  // Call the filtering function
    });
});

</script>

<script>

$(document).ready(function () {
    $("#search-bar").on("keyup", function () {
        let searchQuery = $(this).val().trim();  // Get the input value

        $.ajax({
            url: "/search-data/",  // Django endpoint for searching
            type: "GET",
            data: { query: searchQuery },  // Send the search query
            dataType: "json",
            success: function (response) {
                $("#table-body").empty();  // Clear previous rows

                response.data.forEach(item => {
                    let highlightedText = highlightText(item.regexp_replace, searchQuery);

                    $("#table-body").append(
                        `<tr>
                            <th scope="row">${ item.id }</th>
                            <td>${ item.survey_type_id }</td>
                            <td>${ item.lang_id }</td>
                            <td>${ item.question_number }</td>
                            <td class="regexp-replace">${ highlightedText }</td>
                            <td>${ item.question_name }</td>
                            <td>${ item.question_type }</td>
                        </tr>`
                    );
                });
            }
        });
    });
});



</script>

<script>

function highlightText(text, query) {
    if (!query) return text; // Return original text if query is empty or null

    // Escape HTML to prevent breaking the table
    function escapeHTML(str) {
        return str.replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");
    }

    let escapedText = escapeHTML(text);
    let escapedQuery = escapeHTML(query);

    // Escape regex special characters
    let safeQuery = escapedQuery.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");

    try {
        // Use regex to wrap matched words in a <span>
        let regex = new RegExp(`(${safeQuery})`, "gi");

        return escapedText.replace(regex, '<span style="background-color: red; color: white; padding: 2px; border-radius: 3px;">$1</span>');
    } catch (error) {
        console.error("Regex Error:", error);
        return escapedText; // If an error occurs, return the escaped text
    }
}



$(document).ready(function () {
    var ctx = document.getElementById("surveyChart").getContext("2d");

    var surveyBarChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: [],
            datasets: [{
                label: "Response Count",
                data: [],
                backgroundColor: "rgba(239, 35, 60, 0.8)", // Softer red
                hoverBackgroundColor: "rgba(239, 35, 60, 1)", // Highlight effect
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: { top: 10, bottom: 10 } // Extra padding for spacing
            },
            scales: {
                x: {
    title: { 
        display: true, 
        text: "", 
        font: { size: 14, weight: "bold" } 
    },
    grid: { display: false },
    barPercentage: 0.6,
    categoryPercentage: 0.8,
    ticks: {
        font: { size: 12 },
        maxRotation: 0, // Prevent tilt
        minRotation: 0,
        autoSkip: false, // Prevent labels from being skipped
    }
},
                y: {
                    title: { 
                        display: true, 
                        text: "Response Count", 
                        font: { size: 14, weight: "bold" } 
                    },
                    beginAtZero: true,
                    ticks: { font: { size: 12 } },
                    grid: { color: "rgba(200, 200, 200, 0.3)" } // Softer grid lines
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: "rgba(0,0,0,0.7)", // Darker tooltip
                    titleFont: { size: 14, weight: "bold" },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function (tooltipItem) {
                            return `Count: ${tooltipItem.formattedValue}`;
                        }
                    }
                }
            },
        }
    });

    function fetchData() {
        $.ajax({
            url: "/api/chart-data/",
            method: "GET",
        }).done(function (response) {
            console.log("API Response:", response);

            surveyBarChart.data.labels = response.labels;
            surveyBarChart.data.datasets[0].data = response.data;
            surveyBarChart.update();
        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error("AJAX error:", textStatus, errorThrown);
        });
    }

    fetchData();  
    setInterval(fetchData, 5000);
});



</script>



{% endblock %}
